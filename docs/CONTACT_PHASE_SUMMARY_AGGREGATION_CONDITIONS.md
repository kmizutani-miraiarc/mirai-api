# フェーズ集計の集計条件

## 概要

このドキュメントでは、コンタクトフェーズ集計バッチスクリプトの集計条件を説明します。

## 集計対象

### 1. コンタクト取得条件

- **取得方法**: HubSpot APIから全コンタクトを取得（フィルタなし）
- **取得プロパティ**: 
  - `hubspot_owner_id`（必須）
  - `contractor_buy_phase` または ラベル「仕入フェーズ」で検出されたプロパティ名
  - `contractor_sell_phase` または ラベル「販売フェーズ」で検出されたプロパティ名
- **ページネーション**: 100件ずつ取得し、全件を処理

### 2. 担当者フィルタ条件

- **判定方法**: `hubspot_owner_id`で判定
- **対象担当者ID**:
  - `75947324`: 久世 健人
  - `75947364`: 赤瀬 公平
  - `75947430`: 藤森 日加里
  - `75947440`: 岩崎 陽
  - `78042426`: 藤村 ひかり

**スキップ条件**:
- `hubspot_owner_id`が空（NULL）の場合 → スキップ
- `hubspot_owner_id`が対象担当者IDに含まれない場合 → スキップ

### 3. フェーズ条件

- **仕入フェーズ**: `contractor_buy_phase` または ラベル「仕入フェーズ」で検出されたプロパティ
- **販売フェーズ**: `contractor_sell_phase` または ラベル「販売フェーズ」で検出されたプロパティ
- **有効なフェーズ値**: `S`, `A`, `B`, `C`, `D`, `Z`
- **正規化処理**:
  - 空欄（NULL、空文字列）の場合は`None`を返す（集計対象外）
  - ラベル形式（例：「S：成約した」）からフェーズ値を抽出
  - マッピングテーブルを使用してラベルをフェーズ値に変換

**集計条件**:
- **どちらか一方でも有効な値（S, A, B, C, D, Z）があれば集計対象**
- 空欄（None）のフェーズはNULLとして保存し、実際の'Z'フェーズと区別する
- 両方のフェーズが空欄（None）の場合は集計対象外

**スキップ条件**:
- 両方のフェーズが空欄（None）の場合 → スキップ

**空欄の扱い**:
- **仕入フェーズが空欄で販売フェーズが有効な場合**:
  - `buy_phase=NULL`, `sell_phase=有効な値` として保存
  - 仕入フェーズはカウントしない（無視）
  - 販売フェーズのみ集計
- **販売フェーズが空欄で仕入フェーズが有効な場合**:
  - `buy_phase=有効な値`, `sell_phase=NULL` として保存
  - 販売フェーズはカウントしない（無視）
  - 仕入フェーズのみ集計
- **空欄のフェーズはNULLとして保存され、実際の'Z'フェーズとは区別される**

## 集計ロジック

### 集計キー

- `aggregation_date`: 集計日（週の開始日、月曜日）
- `owner_id`: 担当者ID（HubSpot）
- `buy_phase`: 仕入フェーズ（S, A, B, C, D, Z または NULL（空欄））
- `sell_phase`: 販売フェーズ（S, A, B, C, D, Z または NULL（空欄））

### 集計値

- `count`: 該当する条件に一致するコンタクトの件数

## 集計統計（最新実行結果の例）

```
総コンタクト数: 19,310件
処理済みコンタクト数: 19,310件
集計成功: 9,983件

スキップ理由:
- 担当者IDなし: 73件
- 対象外担当者: 870件
- 仕入フェーズなし: 2,105件
- 販売フェーズなし: 1,817件
- 両方のフェーズなし: 4,462件

合計スキップ: 9,327件
集計成功: 9,983件
合計: 19,310件 ✓
```

## 注意事項

1. **コンタクトは全て取得**: HubSpot APIから全コンタクトを取得しています（フィルタなし）
2. **担当者フィルタ**: 対象担当者IDに一致するもののみを集計対象とします
3. **フェーズ条件**: どちらか一方でも有効な値があれば集計対象とします
4. **空欄の扱い**: 空欄のフェーズはNULLとして保存され、実際の'Z'フェーズとは区別されます。空欄のフェーズはカウントされません（無視されます）

## 集計結果の確認方法

1. データベースの`contact_phase_summary`テーブルを確認
2. 集計日のデータを確認
3. 担当者ID、仕入フェーズ、販売フェーズの組み合わせで件数を確認

## トラブルシューティング

### 集計結果に差異がある場合

1. **コンタクト取得の確認**
   - ログで「総件数」を確認
   - HubSpotのコンタクト総数と比較

2. **担当者フィルタの確認**
   - ログで「対象外担当者」の件数を確認
   - 対象担当者IDが正しく設定されているか確認

3. **フェーズ条件の確認**
   - ログで「仕入フェーズなし」「販売フェーズなし」の件数を確認
   - フェーズプロパティ名が正しく検出されているか確認
   - フェーズ値の正規化が正しく行われているか確認

4. **集計ロジックの確認**
   - データベースに保存されているデータを確認
   - 集計キー（owner_id, buy_phase, sell_phase）の組み合わせを確認

