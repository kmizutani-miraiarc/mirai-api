name: Deploy to Production Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 手動実行も可能

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run tests (if any)
      run: |
        # テストファイルがある場合のみ実行
        if [ -f "test_*.py" ] || [ -d "tests" ]; then
          python -m pytest tests/ -v
        else
          echo "No tests found, skipping test step"
        fi
        
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # デプロイディレクトリに移動
          cd /var/www/mirai-api
          
          # 既存のアプリケーションを停止
          sudo systemctl stop mirai-api || true
          
          # バックアップを作成
          if [ -f "main.py" ]; then
            sudo mkdir -p backups
            sudo tar -czf backups/app.backup.$(date +%Y%m%d_%H%M%S).tar.gz --exclude='backups' --exclude='*.tar.gz' --exclude='.git' .
          fi
          
          # Gitから最新のコードを取得
          git fetch origin
          git reset --hard origin/main
          
          # 権限を設定
          sudo chmod -R 755 .
          
          # 仮想環境を作成・更新
          if [ ! -d "venv" ]; then
            sudo python3 -m venv venv
          fi
          
          # 依存関係をインストール
          sudo venv/bin/pip install --upgrade pip
          sudo venv/bin/pip install -r requirements.txt
          
          # サービスファイルをコピーしてsystemdをリロード
          if [ -f "mirai-api.service" ]; then
            echo "Copying service file..."
            sudo cp mirai-api.service /etc/systemd/system/
            sudo systemctl daemon-reload
            echo "Service file copied and systemd reloaded"
          else
            echo "Warning: mirai-api.service not found in repository"
          fi
          
          # アプリケーションを起動
          echo "Starting mirai-api service..."
          sudo systemctl start mirai-api
          sudo systemctl enable mirai-api
          
          # サービスの状態を確認
          echo "Checking service status..."
          sudo systemctl status mirai-api --no-pager -l || true
          
          # ログを確認
          echo "Recent service logs:"
          sudo journalctl -u mirai-api -n 50 --no-pager || true
          
          # ヘルスチェック（複数回リトライ）
          echo "Performing health check..."
          HEALTH_CHECK_PASSED=false
          for i in {1..10}; do
            sleep 3
            if curl -f http://127.0.0.1:8000/health > /dev/null 2>&1; then
              echo "Health check passed on attempt $i!"
              HEALTH_CHECK_PASSED=true
              break
            else
              echo "Health check failed (attempt $i/10), retrying in 3 seconds..."
              # サービスが停止している場合は再起動を試みる
              if ! sudo systemctl is-active --quiet mirai-api; then
                echo "Service is not active, attempting restart..."
                sudo systemctl restart mirai-api
                sleep 5
                # 再起動後のログを確認
                sudo journalctl -u mirai-api -n 20 --no-pager || true
              fi
            fi
          done
          
          if [ "$HEALTH_CHECK_PASSED" = false ]; then
            echo "Deployment failed - health check failed after 10 attempts"
            echo "Service status:"
            sudo systemctl status mirai-api --no-pager -l || true
            echo "Recent logs:"
            sudo journalctl -u mirai-api -n 100 --no-pager || true
            echo "Checking if port 8000 is in use:"
            sudo netstat -tlnp | grep 8000 || sudo ss -tlnp | grep 8000 || echo "Port 8000 is not in use"
            # ロールバック
            sudo systemctl stop mirai-api || true
            if ls backups/app.backup.*.tar.gz 1> /dev/null 2>&1; then
              LATEST_BACKUP=$(ls -t backups/app.backup.*.tar.gz | head -1)
              echo "Rolling back to: $LATEST_BACKUP"
              sudo tar -xzf "$LATEST_BACKUP"
              sudo systemctl start mirai-api
            fi
            exit 1
          else
            echo "Deployment successful!"
          fi
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Deployment completed successfully!"
        else
          echo "❌ Deployment failed!"
        fi
